<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¾ Adopt a Pet | PetVerse</title>

  <!-- âœ… Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- âœ… Flask-compatible static path -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- âœ… Navbar -->
  <nav class="navbar">
    <div class="logo">PetVerse ğŸ¾</div>
    <ul>
      <li><a href="{{ url_for('home') }}">Home</a></li>
      <li><a href="{{ url_for('render_page', page='pets') }}" style="color:var(--primary);">Adopt</a></li>
      <li><a href="{{ url_for('render_page', page='volunteer') }}">Volunteer</a></li>
      <li><a href="{{ url_for('render_page', page='donate') }}">Donate</a></li>
      <li><a href="{{ url_for('render_page', page='community') }}">Community</a></li>
      <li><a href="{{ url_for('render_page', page='lost-found') }}">Lost & Found</a></li>
      <li><a href="{{ url_for('render_page', page='login') }}" id="loginLink">Login / Signup</a></li>
      <li><a href="{{ url_for('render_page', page='myadoptions') }}">My Adoptions</a></li>

      <li id="logoutItem" style="display:none;">
        <a href="javascript:void(0)" id="logoutLink" style="color:var(--secondary)">Logout</a>
      </li>

      <li>
        <select id="languageSelect" onchange="changeLanguage(this.value)"
          style="background:var(--primary-light);color:white;border:none;padding:0.5rem;border-radius:var(--radius);">
          <option value="en">English</option>
          <option value="hi">à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
          <option value="kn">à²•à²¨à³à²¨à²¡</option>
        </select>
      </li>
    </ul>
  </nav>

  <!-- âœ… Hero Section -->
  <div class="hero">
    <h1>Find Your Perfect Companion</h1>
    <p>Give a loving home to pets waiting for their forever family ğŸ¡</p>
  </div>

  <!-- âœ… Category Filter -->
  <div class="category-filter">
    <button class="category-btn active" onclick="filterPets('all')">All Pets</button>
    <button class="category-btn" onclick="filterPets('dog')">Dogs ğŸ•</button>
    <button class="category-btn" onclick="filterPets('cat')">Cats ğŸˆ</button>
    <button class="category-btn" onclick="filterPets('bird')">Birds ğŸ¦</button>
    <button class="category-btn" onclick="filterPets('rabbit')">Rabbits ğŸ‡</button>
  </div>

  <!-- âœ… Pets Grid -->
  <div id="pets-container" class="pets-grid">Loading pets...</div>

  <div id="toast" class="toast"></div>

  <!-- âœ… Core Script -->
  <script>
    const container = document.getElementById("pets-container");
    const toast = document.getElementById("toast");
    let allPets = [];

    // ğŸ”¹ Login state management
    function updateAuthLinks() {
      const user = localStorage.getItem("petpal_user");
      const loginLink = document.getElementById("loginLink");
      const logoutItem = document.getElementById("logoutItem");
      const logoutLink = document.getElementById("logoutLink");

      if (user) {
        loginLink.innerHTML = `Welcome, ${user} ğŸ‘‹`;
        loginLink.style.color = "var(--accent)";
        loginLink.href = "javascript:void(0)";
        loginLink.onclick = () => showToast(`Already logged in as ${user}`);
        logoutItem.style.display = "block";
        logoutLink.onclick = logout;
      } else {
        loginLink.innerHTML = "Login / Signup";
        loginLink.href = "{{ url_for('render_page', page='login') }}";
        logoutItem.style.display = "none";
      }
    }

    function logout() {
      const user = localStorage.getItem("petpal_user");
      localStorage.removeItem("petpal_user");
      showToast(`Goodbye, ${user}!`);
      updateAuthLinks();
      setTimeout(() => window.location.href = "{{ url_for('home') }}", 1500);
    }

    // ğŸ”¹ Toast helper
    function showToast(message, type = 'info') {
      toast.innerText = message;
      toast.style.background = type === 'error' ? '#ff6b6b' :
                              type === 'success' ? 'var(--accent)' :
                              'var(--primary)';
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    // ğŸ”¹ Filter pets
    function filterPets(category) {
      document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      const filtered = category === 'all' ? allPets : allPets.filter(pet => pet.type.toLowerCase().includes(category));
      displayPets(filtered);
    }

    // ğŸ”¹ Display pets dynamically
    function displayPets(pets) {
      container.innerHTML = "";
      if (!pets.length) {
        container.innerHTML = `<p style="text-align:center;grid-column:1/-1;color:var(--text-light);">No pets found ğŸ¾</p>`;
        return;
      }

      pets.forEach(pet => {
        const card = document.createElement("div");
        card.className = "pet-card";
        card.innerHTML = `
          <img src="/static/images/${pet.image}" alt="${pet.name}"
               onerror="this.src='https://via.placeholder.com/300x200/8B5FBF/FFFFFF?text=Pet+Image'">
          <div class="pet-card-content">
            <h3>${pet.name}</h3>
            <span class="type">${pet.type}</span>
            <p><strong>Age:</strong> ${pet.age}</p>
            <p><strong>Description:</strong> ${pet.description}</p>
            <button class="adopt-btn" data-id="${pet.id}">Adopt ${pet.name}</button>
          </div>
        `;

        card.querySelector(".adopt-btn").addEventListener("click", async e => {
          const user = localStorage.getItem("petpal_user");
          const petId = e.target.dataset.id;

          if (!user) {
            showToast("Please login to adopt a pet ğŸ¾");
            return;
          }

          try {
            const res = await fetch("/api/adopt", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ user_name: user, pet_id: petId })
            });
            const data = await res.json();

            if (data.error) showToast(data.error, 'error');
            else {
              showToast(data.message, 'success');
              card.style.display = "none";
            }
          } catch (err) {
            showToast("Adoption failed. Please try again later.", "error");
          }
        });

        container.appendChild(card);
      });
    }

    // ğŸ”¹ Load pets from backend
    async function loadPets() {
      try {
        const res = await fetch("/api/pets");
        if (!res.ok) throw new Error("Failed to load pets");
        allPets = await res.json();
        displayPets(allPets);
      } catch (err) {
        container.innerHTML = `<p style='text-align:center;grid-column:1/-1;color:var(--text-light);'>âš ï¸ Could not load pets. Please try again later.</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      updateAuthLinks();
      loadPets();
    });
  </script>

  <!-- âœ… Include global scripts -->
  <script src="{{ url_for('static', filename='header.js') }}"></script>
  <script src="{{ url_for('static', filename='chatbot_floating.js') }}"></script>

  <!-- âœ… Floating Chatbot -->
  <div id="chatbotFloatingIcon"
       style="width:60px;height:60px;background:linear-gradient(135deg,#9b59b6,#c39bd3);
       border-radius:50%;position:fixed;bottom:25px;right:25px;
       display:none;justify-content:center;align-items:center;cursor:pointer;
       box-shadow:0 5px 15px rgba(0,0,0,0.3);z-index:9999;">
    <span style="font-size:28px;">ğŸ¤–</span>
  </div>

  <div id="chatbotPanel"
       style="width:350px;height:500px;background:white;border-radius:20px;
       position:fixed;bottom:100px;right:25px;display:none;
       flex-direction:column;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.25);
       z-index:10000;">
    <div style="padding:15px;background:#9b59b6;color:white;display:flex;align-items:center;gap:10px;">
      <img src="https://cdn-icons-png.flaticon.com/512/620/620851.png"
           style="width:36px;height:36px;border-radius:50%;border:2px solid white;">
      <strong>PetVerse AI Assistant ğŸ¾</strong>
    </div>
    <div id="chatMessagesAI" style="flex:1;padding:10px;overflow-y:auto;background:#f8f0ff;"></div>
    <div style="padding:10px;background:white;display:flex;gap:8px;">
      <input id="chatInputAI" type="text" placeholder="Type your messageâ€¦"
             style="flex:1;padding:10px;border-radius:15px;border:1px solid #d5c4e6;">
      <button id="sendChatBtnAI"
              style="background:#9b59b6;color:white;border:none;padding:10px 14px;
              border-radius:14px;">â¤</button>
    </div>
  </div>
</body>
</html>
